#' Zones exploitables
#'
#' @description Affichage des zones exploitables (pente<0.30) par tracteur sur le MNT
#'
#' @return La fonction renvoit le MNT
#'
#' @param r = un modèle numérique de terrain
#' @param shp = la route au format sf
#'
#' @import sf
#' @import tidyverse
#' @import raster
#' @import sp
#'
#' @author Max Bruciamacchie
#'
#'
#'
#' @export
#'

ExploiTracteur <- function(shp, r, amont=50, aval=150, pas=50, conc=1.8, plane=0.3){
  # --------- TESTS --------
  if(!inherits(shp, "sf") & !(st_geometry_type(st_union(shp)) %in% c("LINESTRING", "MULTILINESTRING"))) {
    stop(cat("la fonction nécessite en entrée un objet sf de type LINESTRING."))
  }
  if(class(r) != "RasterLayer") {
    stop(cat("la fonction nécessite en entrée un objet de type rasterLayer"))
  }

  zone <- st_buffer(shp, dist=300)
  r <- crop(r, as(zone, "Spatial"))
  pente <- terrain(r, opt="slope", unit="tangent", neighbors=8)
  pente[pente > plane] <- NA
  pente[pente <= plane] <- 1
  route <- st_buffer(shp, dist=3)

  plat <- st_as_sf(stars::st_as_stars(pente), as_points = F, merge = T) %>%
    st_buffer(dist=5) %>%
    st_buffer(dist=-5) %>%
    mutate(Surf = as.numeric(st_area(.))) %>%
    filter(Surf > 1000) %>%
    st_transform(2154)

  plat <- plat %>%
    filter(st_intersects(geometry, st_buffer(shp, dist=3), sparse = F))

  buf <- BufferDissy(shp, r, amont,aval,pas,conc)
  buf <- st_union(buf, plat)

return(buf)
}


